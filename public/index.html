<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <!-- Codifica caratteri UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Adatta la pagina ai dispositivi mobili -->
    <link rel="icon" href="idea.png" />
    <!-- Icona della pagina -->
    <title>Bacheca Idee</title>
    <!-- Titolo della pagina -->
    <link rel="stylesheet" href="style.css" />
    <!-- Collegamento al CSS esterno -->
  </head>

  <body>
    <!-- HEADER -->
    <header>
      <h1>üí° Bacheca Idee</h1>
      <!-- Titolo principale -->
      <button id="themeToggle">üåô</button>
      <!-- Bottone per cambiare tema -->
    </header>

    <!-- MAIN -->
    <main>
      <!-- Form per inserire nuove idee -->
      <form id="ideaForm">
        <input type="text" id="author" placeholder="Autore" required />
        <!-- Nome autore -->
        <input type="text" id="title" placeholder="Titolo dell‚Äôidea" required />
        <!-- Titolo idea -->
        <textarea
          id="description"
          placeholder="Descrizione"
          required
        ></textarea>
        <!-- Descrizione idea -->
        <select id="category" required>
          <!-- Categoria dell‚Äôidea -->
          <option value="">Seleziona una categoria</option>
          <option value="tecnologia">Tecnologia</option>
          <option value="educazione">Educazione</option>
          <option value="ambiente">Ambiente</option>
          <option value="altro">Altro</option>
        </select>
        <select id="status" required>
          <!-- Stato iniziale dell‚Äôidea -->
          <option value="in corso">In corso</option>
          <option value="approvata">Approvata</option>
          <option value="scartata">Scartata</option>
        </select>
        <button type="submit">üíæ Pubblica idea</button>
        <!-- Pulsante invio -->
      </form>

      <!-- Contenitore dove verranno inserite tutte le idee -->
      <div id="ideasList"></div>
    </main>

    <!-- Contenitore toast per messaggi temporanei -->
    <div id="toast"></div>

    <script>
      const API_URL = "http://localhost:3000/api/ideas"; // URL API backend

      //  TEMA
      const themeBtn = document.getElementById("themeToggle"); // Bottone tema
      const savedTheme = localStorage.getItem("theme"); // Recupera tema salvato
      if (savedTheme === "dark") document.body.classList.add("dark"); // Applica tema dark se salvato
      themeBtn.textContent = document.body.classList.contains("dark")
        ? "‚òÄÔ∏è"
        : "üåô"; // Imposta icona

      themeBtn.addEventListener("click", () => {
        // Cambio tema al click
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        themeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", isDark ? "dark" : "light"); // Salva scelta
      });

      // TOAST
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const config = {
          // Colori e icone per tipo di messaggio
          success: { color: "#27ae60", icon: "‚úÖ" },
          error: { color: "#c0392b", icon: "‚ùå" },
          warning: { color: "#f39c12", icon: "‚ö†Ô∏è" },
          info: { color: "#3498db", icon: "üí°" },
        };
        const { color, icon } = config[type] || config.info;
        toast.textContent = `${icon} ${message}`; // Testo toast
        toast.style.backgroundColor = color;
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
        toast.style.pointerEvents = "auto";
        setTimeout(() => {
          // Nasconde dopo 2,5s
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-20px)";
          toast.style.pointerEvents = "none";
        }, 2500);
      }

      //  ESCAPE HTML
      function escapeHtml(s) {
        // Previene XSS
        if (!s) return "";
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      // FETCH IDEE
      async function fetchIdeas() {
        // Recupera tutte le idee
        try {
          const res = await fetch(API_URL);
          const ideas = await res.json();
          const list = document.getElementById("ideasList");
          list.innerHTML = ""; // Pulisce contenitore
          ideas.forEach((idea) => {
            // Cicla tutte le idee
            const div = document.createElement("div");
            div.className = "idea"; // Classe card
            div.innerHTML = `
              <h3>${escapeHtml(idea.title)}
                <span class="status ${
                  idea.status === "approvata"
                    ? "approvata"
                    : idea.status === "scartata"
                      ? "scartata"
                      : "in-corso"
                }">${idea.status}</span>
              </h3>
              <p>${escapeHtml(idea.description)}</p>
              <small><b>${escapeHtml(idea.author)}</b> ‚Äî ${escapeHtml(idea.category)} ‚Äî ${new Date(idea.createdAt).toLocaleDateString()}</small>
              <div class="idea-buttons">
                <button class="like" onclick="likeIdea('${idea._id}')">‚ù§Ô∏è ${idea.likes ?? 0}</button>
                <button onclick="editIdea('${idea._id}')">‚úèÔ∏è Modifica</button>
                <button onclick="deleteIdea('${idea._id}')">üóëÔ∏è Elimina</button>
              </div>
            `;
            list.appendChild(div); // Aggiunge card al DOM
          });
        } catch (err) {
          showToast("‚ùå Errore nel caricare le idee", "error"); // Messaggio errore
        }
      }

      //  CREAZIONE NUOVA IDEA
      document
        .getElementById("ideaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault(); // Previene refresh pagina
          const newIdea = {
            author: document.getElementById("author").value,
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            category: document.getElementById("category").value,
            status: document.getElementById("status").value,
            likes: 0, // Valore iniziale
          };
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newIdea),
          });
          if (res.ok) {
            showToast("Idea pubblicata con successo!", "success");
            e.target.reset(); // Reset form
            fetchIdeas(); // Aggiorna lista
          } else showToast("Errore nella pubblicazione", "error");
        });

      //  MODIFICA IDEA CON CONTROLLO STATUS
      async function editIdea(id) {
        // Prompt per titolo e descrizione
        const newTitle = prompt("Nuovo titolo:");
        const newDesc = prompt("Nuova descrizione:");

        // Prompt per status
        let newStatus = prompt("Nuovo status (in corso, approvata, scartata):");

        // Se l‚Äôutente non inserisce nulla, esce
        if (!newTitle && !newDesc && !newStatus) return;

        // Validazione dello status
        const validStatus = ["in corso", "approvata", "scartata"];
        if (newStatus) {
          newStatus = newStatus.toLowerCase().trim();
          if (!validStatus.includes(newStatus)) {
            showToast("‚ö†Ô∏è Status non valido! Modifica annullata.", "warning");
            return; // Esce senza fare la richiesta PATCH
          }
        }

        // Prepara il corpo della richiesta solo con i campi inseriti
        const body = {};
        if (newTitle) body.title = newTitle;
        if (newDesc) body.description = newDesc;
        if (newStatus) body.status = newStatus;

        // Invia la richiesta PATCH solo se ci sono campi validi
        const res = await fetch(`${API_URL}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (res.ok) {
          showToast("Idea aggiornata con successo!", "info");
          fetchIdeas(); // Aggiorna la lista
        } else showToast("Errore durante l‚Äôaggiornamento", "error");
      }

      // ELIMINA IDEA
      async function deleteIdea(id) {
        if (confirm("Vuoi davvero eliminare questa idea?")) {
          const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          if (res.ok) {
            showToast("Idea eliminata con successo", "warning");
            fetchIdeas();
          } else showToast("Errore durante la cancellazione", "error");
        }
      }

      // MI PIACE
      async function likeIdea(id) {
        const res = await fetch(`${API_URL}/${id}`);
        const idea = await res.json();
        const newLikes = (idea.likes || 0) + 1;
        const updateRes = await fetch(`${API_URL}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ likes: newLikes }),
        });
        if (updateRes.ok) {
          showToast('Hai messo "Mi piace"!', "success");
          fetchIdeas();
        } else showToast("Errore nel mettere Mi Piace", "error");
      }

      //  AVVIO
      fetchIdeas(); // Carica tutte le idee all‚Äôavvio
    </script>
  </body>
</html>
