<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="idea.png" />
    <title>Bacheca Idee</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üí° Bacheca Idee</h1>
      <button id="themeToggle">üåô</button>
    </header>

    <main>
      <form id="ideaForm">
        <input type="text" id="author" placeholder="Autore" required />
        <input type="text" id="title" placeholder="Titolo dell‚Äôidea" required />
        <textarea
          id="description"
          placeholder="Descrizione"
          required
        ></textarea>
        <select id="category" required>
          <option value="">Seleziona una categoria</option>
          <option value="tecnologia">Tecnologia</option>
          <option value="educazione">Educazione</option>
          <option value="ambiente">Ambiente</option>
          <option value="altro">Altro</option>
        </select>
        <select id="status" required>
          <option value="in corso">In corso</option>
          <option value="approvata">Approvata</option>
          <option value="scartata">Scartata</option>
        </select>
        <button type="submit">üíæ Pubblica idea</button>
      </form>

      <div id="ideasList"></div>
    </main>

    <div id="toast"></div>

    <script>
      const API_URL = "http://localhost:3000/api/ideas";

      // ----------------- TEMA -----------------
      const themeBtn = document.getElementById("themeToggle");
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") document.body.classList.add("dark");
      themeBtn.textContent = document.body.classList.contains("dark")
        ? "‚òÄÔ∏è"
        : "üåô";

      themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        themeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // ----------------- TOAST -----------------
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const config = {
          success: { color: "#27ae60", icon: "‚úÖ" },
          error: { color: "#c0392b", icon: "‚ùå" },
          warning: { color: "#f39c12", icon: "‚ö†Ô∏è" },
          info: { color: "#3498db", icon: "üí°" },
        };
        const { color, icon } = config[type] || config.info;
        toast.textContent = `${icon} ${message}`;
        toast.style.backgroundColor = color;
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
        toast.style.pointerEvents = "auto";
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-20px)";
          toast.style.pointerEvents = "none";
        }, 2500);
      }

      function escapeHtml(s) {
        if (!s) return "";
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      // ----------------- CRUD -----------------
      async function fetchIdeas() {
        try {
          const res = await fetch(API_URL);
          const ideas = await res.json();
          const list = document.getElementById("ideasList");
          list.innerHTML = "";
          ideas.forEach((idea) => {
            const div = document.createElement("div");
            div.className = "idea";
            div.innerHTML = `
              <h3>${escapeHtml(idea.title)}
                <span class="status ${
                  idea.status === "approvata"
                    ? "approvata"
                    : idea.status === "scartata"
                      ? "scartata"
                      : "in-corso"
                }">${idea.status}</span>
              </h3>
              <p>${escapeHtml(idea.description)}</p>
              <small><b>${escapeHtml(idea.author)}</b> ‚Äî ${escapeHtml(idea.category)} ‚Äî ${new Date(idea.createdAt).toLocaleDateString()}</small>
              <div class="idea-buttons">
                <button class="like" onclick="likeIdea('${idea._id}')">‚ù§Ô∏è ${idea.likes ?? 0}</button>
                <button onclick="editIdea('${idea._id}')">‚úèÔ∏è Modifica</button>
                <button onclick="deleteIdea('${idea._id}')">üóëÔ∏è Elimina</button>
              </div>
            `;
            list.appendChild(div);
          });
        } catch (err) {
          showToast("‚ùå Errore nel caricare le idee", "error");
        }
      }

      // Creazione nuova idea
      document
        .getElementById("ideaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const newIdea = {
            author: document.getElementById("author").value,
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            category: document.getElementById("category").value,
            status: document.getElementById("status").value,
            likes: 0,
          };
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newIdea),
          });
          if (res.ok) {
            showToast("Idea pubblicata con successo!", "success");
            e.target.reset();
            fetchIdeas();
          } else showToast("Errore nella pubblicazione", "error");
        });

      // Modifica idea
      async function editIdea(id) {
        const newTitle = prompt("Nuovo titolo:");
        const newDesc = prompt("Nuova descrizione:");
        const newStatus = prompt(
          "Nuovo status (in corso, approvata, scartata):"
        );

        if (!newTitle && !newDesc && !newStatus) return;

        const body = {};
        if (newTitle) body.title = newTitle;
        if (newDesc) body.description = newDesc;
        if (newStatus) body.status = newStatus;

        const res = await fetch(`${API_URL}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (res.ok) {
          showToast("Idea aggiornata con successo!", "info");
          fetchIdeas();
        } else showToast("Errore durante l‚Äôaggiornamento", "error");
      }

      // Eliminazione idea
      async function deleteIdea(id) {
        if (confirm("Vuoi davvero eliminare questa idea?")) {
          const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          if (res.ok) {
            showToast("Idea eliminata con successo", "warning");
            fetchIdeas();
          } else showToast("Errore durante la cancellazione", "error");
        }
      }

      // Mi piace
      async function likeIdea(id) {
        const res = await fetch(`${API_URL}/${id}`);
        const idea = await res.json();
        const newLikes = (idea.likes || 0) + 1;
        const updateRes = await fetch(`${API_URL}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ likes: newLikes }),
        });
        if (updateRes.ok) {
          showToast('Hai messo "Mi piace"!', "success");
          fetchIdeas();
        } else showToast("Errore nel mettere Mi Piace", "error");
      }

      // Carica idee all'avvio
      fetchIdeas();
    </script>
  </body>
</html>
