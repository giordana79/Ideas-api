<!doctype html>
<html lang="it">
  <head>
    <!-- Imposta codifica caratteri -->
    <meta charset="UTF-8" />
    <!-- Rende la pagina responsive -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Icona scheda browser -->
    <link rel="icon" href="idea.png" />
    <!-- Titolo pagina -->
    <title>Bacheca Idee</title>
    <!-- Collegamento foglio di stile -->
    <link rel="stylesheet" href="style.css" />
    <style>
      /* ================= STILE MODALE ================= */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--card-bg, #fff);
        color: var(--text-color, #000);
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .modal-content input,
      .modal-content textarea,
      .modal-content select {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .modal-buttons button {
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }

      .save-btn {
        background: #27ae60;
        color: #fff;
      }

      .cancel-btn {
        background: #c0392b;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <!-- ======================= HEADER ======================= -->
    <header>
      <h1>üí° Bacheca Idee</h1>
      <!-- Bottone tema -->
      <button id="themeToggle">üåô</button>
    </header>

    <!-- ======================= MAIN ======================= -->
    <main>
      <!-- ===== FORM per nuove idee ===== -->
      <form id="ideaForm">
        <input type="text" id="author" placeholder="Autore" required />
        <input type="text" id="title" placeholder="Titolo dell‚Äôidea" required />
        <textarea
          id="description"
          placeholder="Descrizione"
          required
        ></textarea>

        <select id="category" required>
          <option value="">Seleziona una categoria</option>
          <option value="tecnologia">Tecnologia</option>
          <option value="educazione">Educazione</option>
          <option value="ambiente">Ambiente</option>
          <option value="altro">Altro</option>
        </select>

        <select id="status" required>
          <option value="in corso">In corso</option>
          <option value="approvata">Approvata</option>
          <option value="scartata">Scartata</option>
        </select>

        <button type="submit">üíæ Pubblica idea</button>
      </form>

      <!-- Contenitore delle idee -->
      <div id="ideasList"></div>
    </main>

    <!-- Toast messaggi -->
    <div id="toast"></div>

    <!-- ================= MODALE DI MODIFICA ================= -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <h3>‚úèÔ∏è Modifica Idea</h3>
        <input type="text" id="editTitle" placeholder="Titolo" />
        <textarea id="editDesc" placeholder="Descrizione"></textarea>
        <select id="editStatus">
          <option value="in corso">In corso</option>
          <option value="approvata">Approvata</option>
          <option value="scartata">Scartata</option>
        </select>
        <div class="modal-buttons">
          <button class="save-btn" id="saveEdit">üíæ Salva</button>
          <button class="cancel-btn" id="cancelEdit">‚ùå Annulla</button>
        </div>
      </div>
    </div>

    <!-- ======================= SCRIPT ======================= -->
    <script>
      const API_URL = "http://localhost:3000/api/ideas"; // API backend

      // ===================== GESTIONE TEMA =====================
      const themeBtn = document.getElementById("themeToggle");
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") document.body.classList.add("dark");
      themeBtn.textContent = document.body.classList.contains("dark")
        ? "‚òÄÔ∏è"
        : "üåô";
      themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        themeBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // ===================== TOAST =====================
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const config = {
          success: { color: "#27ae60", icon: "‚úÖ" },
          error: { color: "#c0392b", icon: "‚ùå" },
          warning: { color: "#f39c12", icon: "‚ö†Ô∏è" },
          info: { color: "#3498db", icon: "üí°" },
        };
        const { color, icon } = config[type] || config.info;
        toast.textContent = `${icon} ${message}`;
        toast.style.backgroundColor = color;
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(-20px)";
        }, 2500);
      }

      // ===================== ESCAPE HTML =====================
      function escapeHtml(s) {
        if (!s) return "";
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      // ===================== CARICA IDEE =====================
      async function fetchIdeas() {
        try {
          const res = await fetch(API_URL);
          const ideas = await res.json();
          const list = document.getElementById("ideasList");
          list.innerHTML = "";
          ideas.forEach((idea) => {
            const div = document.createElement("div");
            div.className = "idea";
            div.innerHTML = `
              <h3>${escapeHtml(idea.title)}
                <span class="status ${
                  idea.status === "approvata"
                    ? "approvata"
                    : idea.status === "scartata"
                      ? "scartata"
                      : "in-corso"
                }">${idea.status}</span>
              </h3>
              <p>${escapeHtml(idea.description)}</p>
              <small><b>${escapeHtml(idea.author)}</b> ‚Äî ${escapeHtml(
                idea.category
              )} ‚Äî ${new Date(idea.createdAt).toLocaleDateString()}</small>
              <div class="idea-buttons">
                <button class="like" onclick="likeIdea('${idea._id}')">‚ù§Ô∏è ${
                  idea.likes ?? 0
                }</button>
                <button onclick="openEditModal('${idea._id}')">‚úèÔ∏è Modifica</button>
                <button onclick="deleteIdea('${idea._id}')">üóëÔ∏è Elimina</button>
              </div>
            `;
            list.appendChild(div);
          });
        } catch (err) {
          showToast("Errore nel caricare le idee", "error");
        }
      }

      // ===================== PUBBLICA NUOVA IDEA =====================
      document
        .getElementById("ideaForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const newIdea = {
            author: document.getElementById("author").value,
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            category: document.getElementById("category").value,
            status: document.getElementById("status").value,
            likes: 0,
          };
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newIdea),
          });
          if (res.ok) {
            showToast("Idea pubblicata!", "success");
            e.target.reset();
            fetchIdeas();
          } else showToast("Errore nella pubblicazione", "error");
        });

      // ===================== MODALE DI MODIFICA =====================
      const modal = document.getElementById("editModal");
      const editTitle = document.getElementById("editTitle");
      const editDesc = document.getElementById("editDesc");
      const editStatus = document.getElementById("editStatus");
      let currentId = null; // ID idea in modifica

      // Apri la modale
      async function openEditModal(id) {
        currentId = id;
        const res = await fetch(`${API_URL}/${id}`);
        const idea = await res.json();
        editTitle.value = idea.title;
        editDesc.value = idea.description;
        editStatus.value = idea.status;
        modal.style.display = "flex"; // Mostra modale
      }

      // Chiudi la modale
      document.getElementById("cancelEdit").onclick = () => {
        modal.style.display = "none";
      };

      // Salva le modifiche
      document.getElementById("saveEdit").onclick = async () => {
        const newTitle = editTitle.value.trim();
        const newDesc = editDesc.value.trim();
        const newStatus = editStatus.value.trim();

        // Controllo validit√† status
        const validStatus = ["in corso", "approvata", "scartata"];
        if (!validStatus.includes(newStatus.toLowerCase())) {
          showToast(
            "Status non valido! Usa: in corso, approvata o scartata.",
            "error"
          );
          return;
        }

        const body = {
          title: newTitle,
          description: newDesc,
          status: newStatus,
        };

        const res = await fetch(`${API_URL}/${currentId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (res.ok) {
          showToast("Idea aggiornata!", "info");
          modal.style.display = "none";
          fetchIdeas();
        } else showToast("Errore durante l‚Äôaggiornamento", "error");
      };

      // ===================== ELIMINA IDEA =====================
      async function deleteIdea(id) {
        if (confirm("Vuoi davvero eliminare questa idea?")) {
          const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          if (res.ok) {
            showToast("Idea eliminata", "warning");
            fetchIdeas();
          } else showToast("Errore durante la cancellazione", "error");
        }
      }

      // ===================== METTI MI PIACE =====================
      async function likeIdea(id) {
        const res = await fetch(`${API_URL}/${id}`);
        const idea = await res.json();
        const newLikes = (idea.likes || 0) + 1;
        const updateRes = await fetch(`${API_URL}/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ likes: newLikes }),
        });
        if (updateRes.ok) {
          showToast('Hai messo "Mi piace"!', "success");
          fetchIdeas();
        } else showToast("Errore nel mettere Mi Piace", "error");
      }

      // ===================== AVVIO =====================
      fetchIdeas();
    </script>
  </body>
</html>
